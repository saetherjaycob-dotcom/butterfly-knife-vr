<script>
AFRAME.registerComponent('dual-handle-knife', {
  init() {
    this.handleA = document.querySelector('#handleA')
    this.handleB = document.querySelector('#handleB')

    // Handle angles
    this.aAngle = 0
    this.bAngle = 0
    this.aVel = 0
    this.bVel = 0

    // Physics constants (tuned)
    this.wristPower = 14
    this.gravity = 5
    this.damping = 0.985
    this.limit = Math.PI

    this.lastRot = this.el.object3D.rotation.x

    // Trigger snaps open / closed
    window.addEventListener('triggerdown', () => {
      const open = this.aAngle < Math.PI / 2
      this.aVel = open ? 6 : -6
      this.bVel = open ? -6 : 6
    })
  },

  tick(time, delta) {
    const dt = delta / 1000
    if (!dt) return

    // Wrist angular acceleration
    const rot = this.el.object3D.rotation.x
    const dRot = rot - this.lastRot
    this.lastRot = rot

    // Momentum from wrist flick
    this.aVel += dRot * this.wristPower
    this.bVel -= dRot * this.wristPower

    // Gravity torque
    this.aVel -= Math.sin(this.aAngle) * this.gravity * dt
    this.bVel -= Math.sin(this.bAngle) * this.gravity * dt

    // Damping
    this.aVel *= this.damping
    this.bVel *= this.damping

    // Integrate
    this.aAngle += this.aVel
    this.bAngle += this.bVel

    // Clamp limits
    this.aAngle = Math.max(0, Math.min(this.limit, this.aAngle))
    this.bAngle = Math.max(0, Math.min(this.limit, this.bAngle))

    // Apply rotation
    this.handleA.object3D.rotation.x = this.aAngle
    this.handleB.object3D.rotation.x = -this.bAngle
  }
})
</script>
