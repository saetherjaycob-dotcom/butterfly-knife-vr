<script>
AFRAME.registerComponent('knife-control', {
  init() {
    this.blade = document.querySelector('#blade')

    this.angle = 0        // blade hinge angle
    this.velocity = 0     // swing speed
    this.maxAngle = Math.PI
    this.minAngle = 0

    this.lastRot = 0
    this.grabbed = true

    window.addEventListener('triggerdown', () => {
      // snap open / closed
      this.angle = this.angle > Math.PI / 2 ? 0 : Math.PI
      this.velocity = 0
    })
  },

  tick(time, delta) {
    const dt = delta / 1000
    if (!dt) return

    // wrist angular velocity
    const rotX = this.el.object3D.rotation.x
    const deltaRot = rotX - this.lastRot
    this.lastRot = rotX

    // add momentum
    this.velocity += deltaRot * 8

    // gravity / damping
    this.velocity *= 0.96
    this.velocity -= Math.sin(this.angle) * 2 * dt

    // integrate
    this.angle += this.velocity

    // clamp hinge
    if (this.angle > this.maxAngle) {
      this.angle = this.maxAngle
      this.velocity *= -0.3
    }
    if (this.angle < this.minAngle) {
      this.angle = this.minAngle
      this.velocity *= -0.3
    }

    // apply rotation
    this.blade.object3D.rotation.x = this.angle
  }
})
</script>
