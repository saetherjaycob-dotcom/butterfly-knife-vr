<script>
AFRAME.registerComponent('knife-control', {
  init() {
    this.blade = document.querySelector('#blade')

    // Blade state
    this.angle = Math.PI * 0.1     // radians
    this.velocity = 0              // angular velocity

    // Physics constants (tuned)
    this.gravity = 6.0
    this.damping = 0.985
    this.wristPower = 18.0
    this.snapStrength = 0.15

    this.minAngle = 0
    this.maxAngle = Math.PI

    this.lastRot = this.el.object3D.rotation.x

    // Trigger = force snap
    window.addEventListener('triggerdown', () => {
      this.velocity = this.angle > Math.PI / 2 ? -6 : 6
    })
  },

  tick(time, delta) {
    const dt = delta / 1000
    if (!dt) return

    // Wrist angular acceleration
    const rot = this.el.object3D.rotation.x
    const deltaRot = rot - this.lastRot
    this.lastRot = rot

    // Add momentum from wrist flicks
    this.velocity += deltaRot * this.wristPower

    // Gravity torque (wants blade to fall)
    this.velocity -= Math.sin(this.angle) * this.gravity * dt

    // Damping (air + hinge friction)
    this.velocity *= this.damping

    // Integrate
    this.angle += this.velocity

    // Hard hinge limits with bounce
    if (this.angle < this.minAngle) {
      this.angle = this.minAngle
      this.velocity *= -0.25
    }
    if (this.angle > this.maxAngle) {
      this.angle = this.maxAngle
      this.velocity *= -0.25
    }

    // Snap assist near open/closed
    if (Math.abs(this.angle - this.maxAngle) < 0.08) {
      this.velocity += this.snapStrength
    }
    if (Math.abs(this.angle - this.minAngle) < 0.08) {
      this.velocity -= this.snapStrength
    }

    // Apply rotation
    this.blade.object3D.rotation.x = this.angle
  }
})
</script>
